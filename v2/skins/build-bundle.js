#!/usr/bin/env node

/**
 * Builds skins-bundle.css by concatenating all individual skin CSS files.
 *
 * Usage:  node v2/skins/build-bundle.js
 * npm:    npm run skins:bundle   (from repo root)
 *
 * The individual skin files (skin.css / skin-dark.css in each subdirectory)
 * are the source of truth. This script generates the bundle.
 */

const fs = require('fs');
const path = require('path');

const skinsDir = __dirname;
const outFile = path.join(skinsDir, 'skins-bundle.css');

// Discover skin directories (alphabetically sorted for deterministic output)
const skinDirs = fs.readdirSync(skinsDir, { withFileTypes: true })
  .filter(d => d.isDirectory())
  .map(d => d.name)
  .sort();

const separator = '═'.repeat(75);
const parts = [];

parts.push(`/**
 * AgnosticUI Skins Bundle  —  DO NOT EDIT
 *
 * Auto-generated by  skins/build-bundle.js
 * Regenerate with:   node v2/skins/build-bundle.js
 *
 * All skin CSS files concatenated into one importable file.
 * Import this AFTER ag-tokens-dark.css in your entry point.
 */`);

for (const dir of skinDirs) {
  const skinCss = path.join(skinsDir, dir, 'skin.css');
  const darkCss = path.join(skinsDir, dir, 'skin-dark.css');

  // Pretty label from directory name: "deep-forest" → "Deep Forest"
  const label = dir.replace(/(^|-)(\w)/g, (_, sep, ch) => (sep ? ' ' : '') + ch.toUpperCase());

  if (fs.existsSync(skinCss)) {
    parts.push(`\n/* ${separator}\n   ${label} — Light\n   ${separator} */\n`);
    parts.push(fs.readFileSync(skinCss, 'utf8').trim());
  }

  if (fs.existsSync(darkCss)) {
    parts.push(`\n/* ${separator}\n   ${label} — Dark\n   ${separator} */\n`);
    parts.push(fs.readFileSync(darkCss, 'utf8').trim());
  }
}

fs.writeFileSync(outFile, parts.join('\n') + '\n');

const count = skinDirs.filter(d =>
  fs.existsSync(path.join(skinsDir, d, 'skin.css'))
).length;

console.log(`✓ skins-bundle.css written (${count} skins)`);

// ── Generate skins-css-data.js (ES module with embedded CSS strings) ──
const cssDataFile = path.join(skinsDir, 'skins-css-data.js');
const entries = [];

for (const dir of skinDirs) {
  const skinCss = path.join(skinsDir, dir, 'skin.css');
  const darkCss = path.join(skinsDir, dir, 'skin-dark.css');
  if (!fs.existsSync(skinCss)) continue;

  const light = fs.readFileSync(skinCss, 'utf8').trim();
  const dark = fs.existsSync(darkCss)
    ? fs.readFileSync(darkCss, 'utf8').trim()
    : '';

  // Escape backticks and ${} in CSS content for template literals
  const esc = s => s.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$\{/g, '\\${');

  entries.push(`  '${dir}': {\n    light: \`${esc(light)}\`,\n    dark: \`${esc(dark)}\`,\n  }`);
}

const cssDataContent = `// AUTO-GENERATED by build-bundle.js — DO NOT EDIT
export const SKINS_CSS = {
${entries.join(',\n')},
};
`;

fs.writeFileSync(cssDataFile, cssDataContent);
console.log(`✓ skins-css-data.js written (${entries.length} skins)`);
