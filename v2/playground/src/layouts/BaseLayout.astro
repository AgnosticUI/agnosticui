---
import { Moon, Sun } from "lucide-astro";

export interface Props {
  title?: string;
  description?: string;
}

const {
  title = "AgnosticUI v2 - AI-Ready Component Library",
  description = "AI-Ready Component Library - Almost Headless, Framework Agnostic"
} = Astro.props;

// Determine if this is the home page to show illustration
const isHomePage = Astro.url.pathname === '/';
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="stylesheet" href="/src/styles/agnostic-shared.css" />

    <!-- Highlight.js for syntax highlighting - Theme-aware CSS -->
    <style>
      /* Default light theme */
      @import url("https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/atom-one-light.min.css");

      /* Dark theme override */
      [data-theme="dark"] {
        --hljs-bg: #282c34;
        --hljs-color: #abb2bf;
      }
    </style>
    <!-- Load dark theme conditionally -->
    <script is:inline>
      (function() {
        function loadDarkTheme() {
          const theme = document.documentElement.getAttribute('data-theme');
          const existingDarkLink = document.getElementById('hljs-dark-theme');

          if (theme === 'dark') {
            if (!existingDarkLink) {
              const link = document.createElement('link');
              link.id = 'hljs-dark-theme';
              link.rel = 'stylesheet';
              link.href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/atom-one-dark.min.css';
              document.head.appendChild(link);
            }
          } else {
            if (existingDarkLink) {
              existingDarkLink.remove();
            }
          }
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', loadDarkTheme);

        // Watch for theme changes
        const observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
              loadDarkTheme();
            }
          });
        });

        observer.observe(document.documentElement, {
          attributes: true,
          attributeFilter: ['data-theme']
        });
      })();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js" onload="console.log('‚úÖ Highlight.js core loaded')" is:inline></script>
    <script is:inline>
      // Load XML language module after core is ready
      document.addEventListener('DOMContentLoaded', () => {
        if (typeof hljs !== 'undefined') {
          const xmlScript = document.createElement('script');
          xmlScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/xml.min.js';
          xmlScript.onload = () => console.log('‚úÖ Highlight.js XML language loaded');
          xmlScript.onerror = () => console.error('‚ùå Failed to load Highlight.js XML language');
          document.head.appendChild(xmlScript);
        } else {
          console.error('‚ùå Highlight.js core not available');
        }
      });

      // Global syntax highlighting function - available to all playground pages
      window.highlightCodeBlocks = function() {
        if (typeof hljs === 'undefined') {
          console.log('‚ö†Ô∏è Highlight.js not loaded yet, retrying...');
          setTimeout(window.highlightCodeBlocks, 100);
          return;
        }

        console.log('üé® Running enhanced Highlight.js processing...');

        // Find all code blocks in the document and inside Shadow DOM
        const allCodeBlocks = [];

        // Standard document query
        document.querySelectorAll('pre code').forEach(block => allCodeBlocks.push(block));

        // Query inside ag-tab-panel elements specifically
        document.querySelectorAll('ag-tab-panel').forEach(panel => {
          // Check if the panel has Shadow DOM
          if (panel.shadowRoot) {
            panel.shadowRoot.querySelectorAll('pre code').forEach(block => allCodeBlocks.push(block));
          }
          // Also check light DOM children
          panel.querySelectorAll('pre code').forEach(block => allCodeBlocks.push(block));
        });

        console.log(`Found ${allCodeBlocks.length} code blocks to highlight`);

        allCodeBlocks.forEach((block, index) => {
          if (!block.classList.contains('hljs')) {
            console.log(`Highlighting code block ${index + 1}: ${block.className}`);

            // Force re-highlight by removing existing highlighting
            block.removeAttribute('data-highlighted');

            // Apply highlighting
            hljs.highlightElement(block);

            console.log(`‚úÖ Code block ${index + 1} highlighted with classes:`, block.classList.toString());
          } else {
            console.log(`‚è≠Ô∏è Code block ${index + 1} already highlighted`);
          }
        });

        // Force a final pass with hljs.highlightAll for anything missed
        hljs.highlightAll();
      };

      // Global initialization for syntax highlighting
      window.initSyntaxHighlighting = function() {
        // Wait for web components to be defined and then highlight
        Promise.all([
          customElements.whenDefined('ag-tabs'),
          customElements.whenDefined('ag-tab'),
          customElements.whenDefined('ag-tab-panel')
        ]).then(() => {
          console.log('‚úÖ Tab components loaded, highlighting code...');

          // Initial highlighting attempt
          setTimeout(window.highlightCodeBlocks, 200);

          // Set up mutation observer to watch for DOM changes
          const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
              if (mutation.type === 'attributes' && mutation.attributeName === 'hidden') {
                console.log('üîç Tab panel visibility changed, re-highlighting...');
                setTimeout(window.highlightCodeBlocks, 50);
              }
            });
          });

          // Observe all tab panels for visibility changes
          document.querySelectorAll('ag-tab-panel').forEach(panel => {
            observer.observe(panel, { attributes: true, attributeFilter: ['hidden'] });
          });
        });

        // Also listen for tab changes to re-highlight
        document.addEventListener('tab-change', () => {
          console.log('üîÑ Tab changed, re-highlighting code...');
          setTimeout(window.highlightCodeBlocks, 100);
        });

        // Additional event listeners for tab interactions
        document.addEventListener('click', (e) => {
          if (e.target && e.target.tagName === 'AG-TAB') {
            console.log('üñ±Ô∏è Tab clicked, will re-highlight code...');
            setTimeout(window.highlightCodeBlocks, 150);
          }
        });
      };
    </script>
  </head>
  <body>
    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode">
      <span class="theme-icon">
        <Moon class="moon-icon" size={20} />
        <Sun class="sun-icon" size={20} />
      </span>
    </button>

    <script>
      // Theme Management - Client-side only
      document.addEventListener('DOMContentLoaded', () => {
        console.log('üü¢ Theme script executing on client');

        // Update toggle button appearance
        function updateThemeToggle(theme) {
          const moonIcon = document.querySelector(".moon-icon");
          const sunIcon = document.querySelector(".sun-icon");
          if (moonIcon && sunIcon) {
            if (theme === "dark") {
              moonIcon.classList.remove("show");
              sunIcon.classList.add("show");
            } else {
              moonIcon.classList.add("show");
              sunIcon.classList.remove("show");
            }
          }
        }

        // 1. Check localStorage first (highest priority)
        const savedTheme = localStorage.getItem("agnostic-theme");

        // 2. Fall back to system preference
        const systemPrefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;

        // 3. Default to light mode if nothing set
        const initialTheme = savedTheme || (systemPrefersDark ? "dark" : "light");

        // Apply theme immediately
        document.documentElement.setAttribute("data-theme", initialTheme);
        updateThemeToggle(initialTheme);

        // Theme toggle click handler
        document.addEventListener('click', function(e) {
          const themeToggleElement = e.target.closest('#themeToggle');
          if (themeToggleElement) {
            e.preventDefault();
            e.stopPropagation();

            const currentTheme = document.documentElement.getAttribute("data-theme");
            const newTheme = currentTheme === "dark" ? "light" : "dark";

            // Update theme
            document.documentElement.setAttribute("data-theme", newTheme);
            localStorage.setItem("agnostic-theme", newTheme);
            updateThemeToggle(newTheme);
          }
        }, true);

        // Listen for system theme changes
        window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", function(e) {
          if (!localStorage.getItem("agnostic-theme")) {
            const theme = e.matches ? "dark" : "light";
            document.documentElement.setAttribute("data-theme", theme);
            updateThemeToggle(theme);
          }
        });
      });
    </script>

    <main class={`agnostic-container ${isHomePage ? 'home' : ''}`}>
      <div class="nav-header">
        <a class="nav-bar-title" href="/" aria-label="AgnosticUI, back to home">
          AgnosticUI v2
        </a>
      </div>

      <slot />
    </main>
  </body>
</html>